name: Build and Deploy

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build deps
        run: pip install markdown

      - name: Build site (_site)
        run: |
          python - << 'PY'
          import re
          import shutil
          from pathlib import Path
          from markdown import markdown

          ROOT = Path(".").resolve()
          OUT = ROOT / "_site"

          def convert_obsidian_callouts(text: str) -> str:
            """
            Convert Obsidian callouts like:
              > [!tip]+ Title
              > body...
            into HTML blocks:
              <div class="callout tip">
                <div class="callout-title">Title</div>
                <div class="callout-body">...</div>
              </div>
            """
            lines = text.splitlines()
            out = []
            i = 0
            head_re = re.compile(r'^\s*>\s*\[!(\w+)\]\+?\s*(.*)\s*$')

            while i < len(lines):
              m = head_re.match(lines[i])
              if not m:
                out.append(lines[i])
                i += 1
                continue

              kind = m.group(1).lower()
              title = (m.group(2) or "").strip() or kind.upper()

              body_lines = []
              i += 1
              while i < len(lines):
                line = lines[i]
                if head_re.match(line):
                  break
                if re.match(r'^\s*>\s?', line):
                  body_lines.append(re.sub(r'^\s*>\s?', '', line))
                  i += 1
                else:
                  break

              body_md = "\n".join(body_lines).strip()

              out.append(f'<div class="callout {kind}">')
              out.append(f'  <div class="callout-title">{title}</div>')
              out.append('  <div class="callout-body">')
              out.append(body_md)
              out.append('  </div>')
              out.append('</div>')

            return "\n".join(out)

          def safe_title(rel: Path) -> str:
            # 用文件名当标题即可
            return rel.stem

          def copy_assets():
            if (ROOT / "assets").exists():
              shutil.copytree(ROOT / "assets", OUT / "assets")

          def copy_static_files():
            keep = {".png",".jpg",".jpeg",".webp",".gif",".svg",".pdf",".css",".js",".json",".yml",".yaml",".woff",".woff2",".ttf"}
            for f in ROOT.rglob("*"):
              if f.is_dir():
                continue
              if ".obsidian" in f.parts or "_site" in f.parts or ".github" in f.parts or "tools" in f.parts:
                continue
              if f.suffix.lower() in keep:
                dest = OUT / f.relative_to(ROOT)
                dest.parent.mkdir(parents=True, exist_ok=True)
                shutil.copy2(f, dest)

          def md_to_html():
            for md in ROOT.rglob("*.md"):
              if ".obsidian" in md.parts or "_site" in md.parts or ".github" in md.parts or "tools" in md.parts:
                continue
              rel = md.relative_to(ROOT)
              out = OUT / rel.with_suffix(".html")
              out.parent.mkdir(parents=True, exist_ok=True)

              md_text = md.read_text(encoding="utf-8")
              md_text = convert_obsidian_callouts(md_text)

              body = markdown(md_text, extensions=["tables", "fenced_code"])
              title = safe_title(rel)

              html = f"""<!doctype html>
          <html lang="zh-CN">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>{title}</title>
            <link rel="stylesheet" href="assets/style.css">
          </head>
          <body>
            <main class="wrap content">
              <article class="card"><div class="md">{body}</div></article>
            </main>
          </body>
          </html>"""
              out.write_text(html, encoding="utf-8")

          def rewrite_links_in_html():
            """
            把 href="xxx.md" 改成 href="xxx"
            以及 href=".../index.md" 改成 href=".../index"
            这样符合你现在“链接不写 .md”的习惯。
            """
            for html in OUT.rglob("*.html"):
              txt = html.read_text(encoding="utf-8")

              # 只处理 href="...md" 和 src="...md" 这类简单情况
              txt = re.sub(r'(href="[^"]+?)\.md(")', r'\1\2', txt)
              txt = re.sub(r"(href='[^']+?)\.md(')", r"\1\2", txt)
              txt = re.sub(r'(src="[^"]+?)\.md(")', r'\1\2', txt)
              txt = re.sub(r"(src='[^']+?)\.md(')", r"\1\2", txt)

              html.write_text(txt, encoding="utf-8")

          # ===== run build =====
          if OUT.exists():
            shutil.rmtree(OUT)
          OUT.mkdir()

          copy_assets()
          copy_static_files()
          md_to_html()
          rewrite_links_in_html()
          PY

      - uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/deploy-pages@v4
